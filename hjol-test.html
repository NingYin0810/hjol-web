<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ä¹å®«æ ¼åˆ®åˆ®ä¹æ¨¡æ‹Ÿå™¨ï¼ˆå«ä¿åº•ï¼‰</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: #f0f0f0;
    }
    h2 {
      margin-top: 20px;
    }
    #scratchContainer {
      display: grid;
      grid-template-columns: repeat(3, 150px);
      gap: 10px;
      justify-content: center;
      margin-top: 30px;
    }
    .cell {
      width: 150px;
      height: 120px;
      border: 2px solid #999;
      background: #fff;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 14px;
      font-weight: bold;
      color: #333;
      padding: 10px;
      white-space: pre-line;
    }
    .win {
      background: #ffe58f;
      border-color: #faad14;
      color: #a8071a;
    }
    .no-win {
      background: #f5f5f5;
      color: #888;
    }
    button {
      margin-top: 30px;
      padding: 10px 30px;
      font-size: 16px;
      cursor: pointer;
    }
    #stats {
      margin-top: 40px;
    }
    table {
      margin: 0 auto;
      border-collapse: collapse;
      width: 220px;
    }
    table, th, td {
      border: 1px solid #888;
    }
    th, td {
      padding: 6px;
    }
    @keyframes scroll {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }

  </style>
</head>
<body>

<h2>ğŸ ä¹å®«æ ¼åˆ®åˆ®ä¹ï¼ˆå«ä¿åº•ï¼‰ ğŸ</h2>

<div id="marquee" style="display: none;background: #ffe58f;color: #a8071a;font-size: 20px;font-weight: bold;padding: 10px;overflow: hidden;position: relative;height: 40px;">
  <div id="marqueeText" style="
    position: absolute;
    white-space: nowrap;
    will-change: transform;
    animation: scroll 12s linear infinite;
  "></div>
</div>



<div id="scratchContainer"></div>
<button onclick="startGame()">å†æ¥ä¸€æ¬¡</button>

<div id="stats">
  <h3>ğŸ¯ æŠ½å¥–ç»Ÿè®¡</h3>
  <p id="drawCount">æŠ½å¥–æ¬¡æ•°ï¼š0</p>
  <table>
    <thead>
      <tr><th>å¥–é¡¹</th><th>æ•°é‡</th></tr>
    </thead>
    <tbody id="rewardTable"></tbody>
  </table>
</div>

<script>
  const prizes = [
    { name: "é‡‘æ¡", num: 18, weight: 20, fallbackWeight: 100 },
    { name: "é‡‘æ¡", num: 28, weight: 15, fallbackWeight: 100 },
    { name: "é‡‘æ¡", num: 66, weight: 10, fallbackWeight: 100 },
    { name: "é‡‘æ¡", num: 88, weight: 8, fallbackWeight: 100 },
    { name: "é‡‘æ¡", num: 128, weight: 5, fallbackWeight: 20 },
    { name: "çº¢è‰²è‹±é›„ç¢ç‰‡", num: 1, weight: 3, fallbackWeight: 100 },
    { name: "é‡‘æ¡", num: 166, weight: 3, fallbackWeight: 10 },
    { name: "çº¢è‰²è‹±é›„ç¢ç‰‡", num: 3, weight: 3, fallbackWeight: 100 },
    { name: "é‡‘æ¡", num: 188, weight: 3, fallbackWeight: 10 },
    { name: "é‡‘æ¡", num: 388, weight: 3, fallbackWeight: 10 },
    { name: "é‡‘æ¡", num: 666, weight: 3, fallbackWeight: 5 },
    { name: "é‡‘æ¡", num: 888, weight: 3, fallbackWeight: 5 },
    { name: "çº¢è‰²è‹±é›„ç¢ç‰‡", num: 8, weight: 3, fallbackWeight: 100 },
    { name: "é‡‘æ¡", num: 1666, weight: 3, fallbackWeight: 2 },
    { name: "é‡‘æ¡", num: 1888, weight: 3, fallbackWeight: 2 },
    { name: "é‡‘æ¡", num: 3888, weight: 3, fallbackWeight: 1 },
    { name: "é‡‘æ¡", num: 6666, weight: 3, fallbackWeight: 1 },
    { name: "çº¢è‰²è‹±é›„ç¢ç‰‡", num: 18, weight: 2, fallbackWeight: 8 },
    { name: "çº¢è‰²è‹±é›„ç¢ç‰‡", num: 38, weight: 2, fallbackWeight: 6 },
    { name: "çº¢è‰²è‹±é›„ç¢ç‰‡", num: 66, weight: 2, fallbackWeight: 5 }
  ];


  const multipliers = [
    { num: 2025, rate: 0.3, multi: 18 },
    { num: 666, rate: 0.7, multi: 6 },
    { num: 66, rate: 1.0, multi: 3 },
    { num: 6, rate: 8.0, multi: 1 }
  ];

  let drawCount = 0;
  let rewardSummary = {
    "é‡‘æ¡": 0,
    "çº¢è‰²è‹±é›„ç¢ç‰‡": 0
  };

  // è¡°å‡ç³»æ•°ï¼ˆè¶Šé«˜å¤§å¥–è¶Šéš¾æŠ½ï¼‰
  const lambda = 0.25;

  // âœ… å¥–å“æŒ‡æ•°è¡°å‡é‡‡æ ·é€»è¾‘
  function computeDecayProbabilities(items, lambda) {
    const decayWeights = items.map((_, i) => Math.exp(-lambda * i));
    const sumWeights = decayWeights.reduce((a, b) => a + b, 0);
    return decayWeights.map(w => w / sumWeights);
  }

  function expDecayRandom(items, lambda) {
    const probs = computeDecayProbabilities(items, lambda);
    const rand = crypto.getRandomValues(new Uint32Array(1))[0] / 2 ** 32;
    let cum = 0;
    for (let i = 0; i < items.length; i++) {
      cum += probs[i];
      if (rand <= cum) return items[i];
    }
    return items[items.length - 1];
  }

  // âœ… ä¿ç•™åŸå§‹å¹¸è¿å·é€»è¾‘
  function getLuckyNumber() {
    const roll = crypto.getRandomValues(new Uint32Array(1))[0] / 2 ** 32 * 100;
    let cum = 0;
    for (let entry of multipliers) {
      cum += entry.rate;
      if (roll <= cum) return entry.num;
    }
    let randNum;
    do {
      randNum = Math.floor(Math.random() * 99) + 1;
    } while ([6, 66].includes(randNum));
    return randNum;
  }

  function getMultiplier(num) {
    const entry = multipliers.find(m => m.num === num);
    return entry ? entry.multi : null;
  }

  function updateRewardTable() {
    const tableBody = document.getElementById("rewardTable");
    tableBody.innerHTML = "";

    for (let key of ["é‡‘æ¡", "çº¢è‰²è‹±é›„ç¢ç‰‡"]) {
      const row = document.createElement("tr");
      const prizeCell = document.createElement("td");
      const countCell = document.createElement("td");
      prizeCell.innerText = key;
      countCell.innerText = rewardSummary[key];
      row.appendChild(prizeCell);
      row.appendChild(countCell);
      tableBody.appendChild(row);
    }

    document.getElementById("drawCount").innerText = `æŠ½å¥–æ¬¡æ•°ï¼š${drawCount}`;
  }

  function startGame() {
  const container = document.getElementById("scratchContainer");
  container.innerHTML = "";
  drawCount++;

  const results = [];

  for (let i = 0; i < 9; i++) {
    const luckyNum = getLuckyNumber();
    const multiplier = getMultiplier(luckyNum);
    const prize = expDecayRandom(prizes, lambda); // âœ… æ¯æ ¼æå‰æŠ½å¥–å“

    results.push({ luckyNum, multiplier, prize });
  }

  // âœ… ä¿åº•é€»è¾‘ï¼šè‹¥ 9 ä¸ªéƒ½æœªä¸­å¥–ï¼Œåˆ™ä»ä¸­é€‰æƒé‡æœ€é«˜çš„å¥–å“æ ¼å­ï¼Œè®¾ä¸ºä¸­å¥–
  const hasWin = results.some(r => r.multiplier);
  if (!hasWin) {
    let maxFallbackWeight = -Infinity;
    let bestIndex = -1;

    for (let i = 0; i < results.length; i++) {
      const prize = results[i].prize;
      if (prize && prize.fallbackWeight > maxFallbackWeight) {
        maxFallbackWeight = prize.fallbackWeight;
        bestIndex = i;
      }
    }

    if (bestIndex !== -1) {
      results[bestIndex].luckyNum = 6;
      results[bestIndex].multiplier = 1;
      console.log(`[ä¿åº•] è®¾ç½®ç¬¬ ${bestIndex + 1} æ ¼ä¸­å¥–ï¼ˆ${results[bestIndex].prize.name}*${results[bestIndex].prize.num}ï¼‰ï¼Œä¿åº•æƒé‡ = ${maxFallbackWeight}`);
    }
  }

  // âœ… æ¸²æŸ“ç»“æœ
  results.forEach(result => {
    const cell = document.createElement("div");
    cell.className = "cell";
    const prizeDisplay = `${result.prize.num} ${result.prize.name}`;

    if (result.multiplier) {
      cell.classList.add("win");
      cell.innerText = `å¹¸è¿å·: ${result.luckyNum}\nğŸ‰ è·å¾—: ${prizeDisplay}\nå€ç‡: Ã—${result.multiplier}`;
      rewardSummary[result.prize.name] += result.prize.num * result.multiplier;
    } else {
      cell.classList.add("no-win");
      cell.innerText = `å¹¸è¿å·: ${result.luckyNum}\nå¥–å“: ${prizeDisplay}\næœªä¸­å¥–`;
    }

    container.appendChild(cell);
  });


    // âœ… åˆ¤æ–­æ˜¯å¦æœ‰å¤§é¢ä¸­å¥–ï¼ˆå•ä¸ªæ ¼å­ >= 888 é‡‘æ¡ æˆ– >= 18 çº¢ç¢ï¼‰
    const hasGoldJackpot = results.some(r =>
      r.multiplier && r.prize.name === "é‡‘æ¡" && r.prize.num >= 888
    );
    const hasFragJackpot = results.some(r =>
      r.multiplier && r.prize.name === "çº¢è‰²è‹±é›„ç¢ç‰‡" && r.prize.num >= 18
    );

    // âœ… è®¡ç®—ä¸­å¥–æ ¼å­ä¸­çš„é‡‘æ¡ / çº¢ç¢æ€»æ•°
    let totalGold = 0;
    let totalFrag = 0;
    let luckyNumGold = 0;
    let luckyNumFrag = 0;

    results.forEach(r => {
      if (r.multiplier) {
        if (r.prize.name === "é‡‘æ¡"){
          totalGold += r.prize.num * r.multiplier;
          luckyNumGold = r.luckyNum;
        }

        else if (r.prize.name === "çº¢è‰²è‹±é›„ç¢ç‰‡") {
          totalFrag += r.prize.num * r.multiplier;
          luckyNumFrag = r.luckyNum;
        }
      }
    });

    const marquee = document.getElementById("marquee");
    const marqueeText = document.getElementById("marqueeText");

    // âœ… æ’­æ”¾è·‘é©¬ç¯å†…å®¹çš„å‡½æ•°ï¼ˆå¯å¤šæ¬¡è°ƒç”¨ï¼‰
    function playMarquee(message) {
      marqueeText.innerText = message;
      marquee.style.display = "block";
      marqueeText.style.animation = "none";
      void marqueeText.offsetWidth; // å¼ºåˆ¶é‡ç»˜
      marqueeText.style.animation = "scroll 12s linear infinite";
    }

    // âœ… æ’­æ”¾é€»è¾‘ï¼ˆä¸²è¡Œï¼‰
    if (hasGoldJackpot && hasFragJackpot) {
      // æ’­æ”¾é‡‘æ¡ -> å»¶æ—¶ -> æ’­æ”¾çº¢ç¢
      playMarquee(`ğŸ‰ æ­å–œæŒ‡æŒ¥å®˜äººå“çˆ†è¡¨ï¼Œåœ¨å‘¨å¹´ç¦è¿å¡æ´»åŠ¨æœŸé—´åˆ®å¼€å¹¸è¿æ•°å­—${luckyNumGold}ï¼Œæ€»è®¡è·å¾—é‡‘æ¡${totalGold}ï¼`);
      setTimeout(() => {
        playMarquee(`ğŸ‰ æ­å–œæŒ‡æŒ¥å®˜äººå“çˆ†è¡¨ï¼Œåœ¨å‘¨å¹´ç¦è¿å¡æ´»åŠ¨æœŸé—´åˆ®å¼€å¹¸è¿æ•°å­—${luckyNumFrag}ï¼Œæ€»è®¡è·å¾—è£è€€é€šç”¨ç¢ç‰‡${totalFrag}ï¼`);
      }, 13000); // è·‘é©¬ç¯ä¸€è½®æ˜¯12sï¼Œè¿™é‡Œç•¥å»¶é•¿ä¸€ç‚¹
    } else if (hasGoldJackpot) {
      playMarquee(`ğŸ‰ æ­å–œæŒ‡æŒ¥å®˜äººå“çˆ†è¡¨ï¼Œåœ¨å‘¨å¹´ç¦è¿å¡æ´»åŠ¨æœŸé—´åˆ®å¼€å¹¸è¿æ•°å­—${luckyNumGold}ï¼Œæ€»è®¡è·å¾—é‡‘æ¡${totalGold}ï¼`);
    } else if (hasFragJackpot) {
      playMarquee(`ğŸ‰ æ­å–œæŒ‡æŒ¥å®˜äººå“çˆ†è¡¨ï¼Œåœ¨å‘¨å¹´ç¦è¿å¡æ´»åŠ¨æœŸé—´åˆ®å¼€å¹¸è¿æ•°å­—${luckyNumFrag}ï¼Œæ€»è®¡è·å¾—è£è€€é€šç”¨ç¢ç‰‡${totalFrag}ï¼`);
    }



  updateRewardTable();
}

  startGame();
</script>



</body>
</html>
